name: Terraform Module Version Checker

on:
  workflow_dispatch:
  schedule:
    - cron: '0 10 * * *'  # Run every day at 7AM - Argentina

jobs:
  check_versions:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v3

      - name: 🛠️ Install dependencies (jq, curl)
        run: sudo apt-get update && sudo apt-get install -y jq curl unzip gnupg lsb-release

      - name: 🛠️ Install Terraform (stable version)
        run: |
          TERRAFORM_VERSION=$(curl -s https://checkpoint-api.hashicorp.com/v1/check/terraform | jq -r .current_version)
          curl -s -LO https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
          terraform -version

      - name: 🚀 Run version checker script
        run: bash .github/scripts/check_versions.sh

      - name: ✅ Check if modules are outdated
        id: check
        run: |
          if [[ -s .module_issues.txt ]]; then
            echo "outdated=true" >> "$GITHUB_OUTPUT"
          else
            echo "outdated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: 🛠️ Install GitHub CLI (gh)
        if: steps.check.outputs.outdated == 'true'
        run: |
          type -p gh || (
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
            sudo apt update && sudo apt install gh -y
          )
          gh --version

      - name: 🐛 Create or update issues for outdated modules
        if: steps.check.outputs.outdated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          while IFS="|" read -r pattern module used latest; do
            title="Upgrade(${pattern}): ${module} (${used} > ${latest})"

            echo "🔍 Searching for existing issue for $module"
            issue_data=$(gh issue list --state open --search "$pattern" --json title,number --jq \
              '.[] | select(.title | contains("'"$pattern"'"))')

            if [[ -z "$issue_data" ]]; then
              echo "🆕 Creating issue: $title"
              gh issue create \
                --title "$title" \
                --body "The module \`${module}\` is outdated.\n\n- Pattern: \`${pattern}\`\n- Used: \`${used}\`\n- Latest: \`${latest}\`" \
                --label terraform
            else
              number=$(echo "$issue_data" | jq -r '.number')
              old_title=$(echo "$issue_data" | jq -r '.title')

              if [[ "$old_title" != *"$latest"* ]]; then
                echo "✏️ Updating issue #$number with new version"
                gh issue edit "$number" \
                  --title "$title" \
                  --body "The module \`${module}\` is outdated.\n\n- Pattern: \`${pattern}\`\n- Used: \`${used}\`\n- Latest: \`${latest}\`"
              else
                echo "✅ Issue already exists and is up to date for $pattern"
              fi
            fi
          done < .module_issues.txt
